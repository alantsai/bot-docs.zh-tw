---
title: Middleware | Microsoft Docs
description: 了解 Bot SDK 內的中介軟體及其使用方式。
keywords: 中介軟體, 中介軟體管道, 最少運算路由, 中介軟體使用
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.subservice: sdk
ms.date: 05/23/2019
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: c70470d66d1402fc3d4c29d8772193f8e0576913
ms.sourcegitcommit: ea64a56acfabc6a9c1576ebf9f17ac81e7e2a6b7
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/24/2019
ms.locfileid: "66215497"
---
# <a name="middleware"></a>中介軟體

[!INCLUDE [applies-to-v4](../includes/applies-to.md)]

中介軟體只是一個介於介面卡和 Bot 邏輯之間的類別，會在初始化期間新增至您介面卡的中介軟體集合中。 SDK 可讓您撰寫自己的中介軟體，或新增他人所建立的中介軟體。 每個透過中介軟體進出 Bot 流程的活動。

介面器透過 Bot 中介軟體管道處理內送活動，並導向至 Bot 邏輯再送出。 如同每個進出 Bot 的活動流程，每個中介軟體都可檢視活動，或在 Bot 邏輯執行之前或之後採取行動。

在說明中介軟體之前，請務必先了解 [Bot 基本資訊](~/v4sdk/bot-builder-basics.md)，以及其[如何處理活動](~/v4sdk/bot-builder-basics.md#the-activity-processing-stack)。

## <a name="uses-for-middleware"></a>使用中介軟體
我們常會遇到這個問題：「何時應該將動作實作為中介軟體，何時又該使用一般的 Bot 邏輯？」 中介軟體會讓您有額外的機會，可在對話的每個「回合」  進行處理之前和之後，與使用者的對話流程互動。 中介軟體也可讓您儲存和擷取關於對話的資訊，並於需要時呼叫其他處理邏輯。 以下是一些常見的案例，可說明中介軟體實用之處。

### <a name="looking-at-or-acting-on-every-activity"></a>查詢每個活動或據以採取行動
在很多情況下，我們會要求 Bot 對每個活動或特定類型的每個活動採取行動。 例如：您可能想記錄 Bot 接收到的每個訊息活動，或如果 Bot 未在該回合產生回應則提供後援回應。 中介軟體是很好的著手點，其可在其餘 Bot 邏輯執行之前或之後執行。

### <a name="modifying-or-enhancing-the-turn-context"></a>修改或增強回合內容
如果 Bot 具有的資訊多過於活動中提供的資訊，則特定交談的成果內容可能更豐富。 在此情況下，中介軟體可查看其至目前為止的對話狀態、查詢外部資料來源，並將資料附加至[回合內容](~/v4sdk/bot-builder-basics.md#defining-a-turn)物件，然後再將執行作業傳遞至該 Bot 邏輯。 

SDK 會定義可記錄傳入和傳出活動的記錄中介軟體，但您也可以定義自己的中介軟體。

## <a name="the-bot-middleware-pipeline"></a>Bot 中介軟體管道
針對每個活動，介面卡可依您新增中介軟體的順序進行呼叫。 針對該回合和 _next_ 委派，介面卡會在內容物件中傳遞，然後中介軟體會呼叫委派，並將控制項傳遞至管道中的下個中介軟體。 中介軟體也有機會在 _next_ 委派傳回之後，先執行其他工作，再完成方法。 您可以想成每個中介軟體物件都有第一次和最後一次的機會，能在管道中和接續於中介軟體物件之後的項目進行互動。

例如︰

- 第 1 個中介軟體物件的回合處理常式在呼叫 _next_ 之前先執行程式碼。
  - 第 2 個中介軟體物件的回合處理常式在呼叫 _next_ 之前先執行程式碼。
    - Bot 的回合處理常式執行並傳回。
  - 第 2 個中介軟體物件的回合處理常式在傳回之前，執行任何其餘程式碼。
- 第 1 個中介軟體物件的回合處理常式在傳回之前，執行任何其餘程式碼。

如果中介軟體未呼叫下個委派，則介面卡不會呼叫任何後續中介軟體或 Bot 回合處理常式，以及管道最少運算路由。

Bot 中介軟體管道完成後，該回合即結束，且回合內容將超出範圍。

中介軟體或 Bot 可產生回應和註冊回應事件處理常式，不過請注意，這些回應會在個別程式中處理。

## <a name="order-of-middleware"></a>中介軟體的順序
由於中介軟體新增的順序會影響其處理活動的順序，因此請務必先決定好新增順序。

> [!NOTE]
> 這表示您會獲得適用於大部分的 Bot 的模式；但請務必考量在您的情境中，中介軟體和使用情境下與其他使用者的互動方式。

中介軟體管道中的第一個項目可能是每次都會執行的最低層級工作。 例如：記錄、例外狀況處理和翻譯。 排列順序取決於您的需求，例如，您想要先翻譯內送訊息，再儲存訊息；還是應該先儲存訊息，這表示不會翻譯所儲存的訊息。

中介軟體管道的最後一個項目是 Bot 特定中介軟體，即您實作的中介軟體，用來處理每次傳送給 Bot 的訊息。 如果您的中介軟體使用狀態資訊或其他 Bot 內容中設定的資訊，請將其新增至中介軟體管道中，用於修改狀態或內容的中介軟體之後。

## <a name="short-circuiting"></a>最少運算路由
另一個有關中介軟體和回應處理常式的重要概念是「最少運算路由」  。 如果系統繼續透過後續的執行層處理該執行作業，則中介軟體 (或回應處理常式) 必須呼叫其 _next_ 委派傳遞執行。  如果未在該中介軟體 (或回應處理常式) 中呼叫下個委派，則相關聯的管線會產生最少運算路由，而後續執行層也不會執行。 這表示所有 Bot 邏輯，以及關線中後續的任何中介軟體都會略過。 中介軟體與對一回合，產生最少運算路由的回應處理常式之間有細微差異。

中介軟體會對一回合，產生最少運算路由，不會呼叫 Bot 回合處理常式，但在管線中此時點之前執行的所有中介軟體程式碼仍會執行到完成為止。 

針對事件處理常式，不呼叫 _next_ 代表事件已取消，這與中介軟體略過邏輯大為不同。 藉由不處理其餘事件，介面卡就永遠無法傳送。

> [!TIP]
> 如果您執行最少運算路由回應事件 (例如 `SendActivities`)，請確保其為您預期的行為。 否則可能會導致您難以修正錯誤。

## <a name="response-event-handlers"></a>回應事件處理常式
除了應用程式和中介軟體邏輯，回應處理常式 (有時也指事件處理常式，或活動事件處理常式) 亦可新增至內容物件。 目前的內容物件發生相關聯回應時，系統在執行實際回應之前會先呼叫處理常式。 如果您已經知道想要針對其餘目前回應中，該類型的每個活動要執行哪些動作 (無論是在實際事件之前或之後執行)，這些處理常式非常實用。

> [!WARNING]
> 請特別小心，不要在其本身的個別回應事件處理常式內，呼叫活動回應方法，例如：從傳送活動處理常式內呼叫傳送活動方法。 這樣可能會產生無限迴圈。

請記住，每個新活動都取得要在其中執行的新執行緒。 建立執行緒處理活動時，該活動的處理常式清單會複製到該執行緒。 系統不會針對該特定活動事件，執行該時間點後新增的任何處理常式。
內容物件上所註冊的處理常式，其處理方式非常類似於介面卡管理中介軟體管線的方式。 也就是說，系統將依照處理常式新增的順序進行呼叫，然後再呼叫下一個委派，將控制項傳遞至下個註冊的事件處理常式。 如果處理常式未呼叫下個委派，則不會呼叫任何後續的事件處理常式，事件會產生最少運算路由，而且介面卡不會傳送回應給通道。

## <a name="handling-state-in-middleware"></a>處理中介軟體中的狀態

儲存狀態的常見方法是在回合處理常式的結尾呼叫「儲存變更」方法。 以下是著重於該呼叫的圖表。

![狀態中介軟體問題](media/bot-builder-dialog-state-problem.png)

此方法的問題是，若是在 Bot 的回合處理常式傳回之後，從某些自訂中介軟體更新任何狀態，則狀態不會儲存到永久性儲存體。 解決方法是將 _auto-save changes_ 中介軟體的執行個體新增至中介軟體堆疊的開頭，或至少在任何可能更新狀態的中介軟體之前，以將對「儲存變更」方法的呼叫移到完成自訂中介軟體之後。 執行如下所示。

![狀態中介軟體解決方案](media/bot-builder-dialog-state-solution.png)

將需要更新的狀態管理物件新增至「Bot 狀態集」  物件，然後在您建立自動儲存變更中介軟體時使用。


## <a name="additional-resources"></a>其他資源
您可以看一下文稿記錄器中介軟體，其實作於 Bot Framework SDK 中 [[C#](https://github.com/Microsoft/botbuilder-dotnet/blob/master/libraries/Microsoft.Bot.Builder/TranscriptLoggerMiddleware.cs) | [JS](https://github.com/Microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/transcriptLogger.ts)]。
