---
title: Middleware | Microsoft Docs
description: 了解 Bot SDK 內的中介軟體及其使用方式。
keywords: 中介軟體, 中介軟體管道, 最少運算路由, 中介軟體使用
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 05/24/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 9986ac7d46acfa94694456d653b91dd66c1f55f0
ms.sourcegitcommit: f95702d27abbd242c902eeb218d55a72df56ce56
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/19/2018
ms.locfileid: "39300591"
---
# <a name="middleware"></a>中介軟體

[!INCLUDE [pre-release-label](~/includes/pre-release-label.md)]

中介軟體只是一個介於介面卡和 Bot 邏輯之間的類別，會在初始化期間新增至您介面卡的中介軟體集合中。 SDK 可讓您撰寫自己的中介軟體，或新增其他人建立且可重複使用的中介軟體。 您可以在中介軟體中做什麼？ 幾乎任何事...每個透過中介軟體進出 Bot 流程的活動。

介面器透過 Bot 中介軟體管道處理內送活動，並導向至 Bot 邏輯再送出。 如同每個進出 Bot 的活動流程，每個中介軟體都可檢視活動，或在 Bot 邏輯執行之前或之後採取行動。

在說明中介軟體之前，請務必先了解 [Bot 基本資訊](~/v4sdk/bot-builder-basics.md)，以及其[如何處理活動](~/v4sdk/bot-builder-concept-activity-processing.md)。

## <a name="uses-for-middleware"></a>使用中介軟體

問題通常是：與 Bot 邏輯相較，應該在中介軟體中導入哪些設定？ 中介軟體極具彈性，因此最終的使用方式完全操之在您。 我們先來介紹幾個中介軟體的理想使用方式。

### <a name="looking-at-or-acting-on-every-activity"></a>查詢每個活動或據以採取行動

在很多情況下，我們會要求 Bot 對每個活動或特定類型的每個活動採取行動。 例如：我們可能想記錄 Bot 接收到的每個訊息活動，或如果 Bot 未在該回合產生回應則提供後援回應。 中介軟體是很好的著手點，其可在其餘 Bot 邏輯執行之前或之後執行。

### <a name="modifying-or-enhancing-the-turn-context"></a>修改或增強回合內容

如果 Bot 具有的資訊多過於活動中提供的資訊，則特定交談的成果內容可能更豐富。 在此情況下，中介軟體可查看其至目前為止的交談狀態、查詢外部資料來源，並將資料附加至內容物件，然後再將執行作業傳遞至該 Bot 邏輯。
例如，中介軟體可識別交談詳細資料 (例如交談識別碼和狀態)，然後查詢資訊的目錄服務。 中介軟體可從外部查詢擷取使用者物件，然後將其新增至內容物件再傳遞，提供更多有關使用者的資料，有助於 Bot 更妥善處理要求。

中介軟體可能會有上述兩種使用情境或其他完全不同的使用方式，全都取決於您要如何安排 Bot 的結構，以及想讓 Bot 達成的任務。
中介軟體可建立或保存狀態、回應內送要求或最少運算路由管道。
部分候選中介軟體包括：

- **儲存或保存**：使用中介軟體在回合結束後儲存或保留值，或根據回合中的情況更新部分值。
- **錯誤處理或正常失敗**：如果擲回例外狀況，則中介軟體可向使用者傳送有關該例外狀況的說明訊息。
- **翻譯**：此中介軟體可偵測並翻譯內送訊息，並設定連出訊息，以翻譯回剛開始偵測之內送訊息使用的語言。

您可定義自己的中介軟體，或者 SDK 可定義代表應用程式獨立元件的中介軟體，例如：

- 在內容物件中保存並還原狀態資訊的狀態中介軟體。 SDK 可提供交談和使用者狀態中介軟體。
- 可辨識輸入語言並翻譯成其他語言 (例如應用程式理解的語言) 的翻譯中介軟體。
- 可記錄內送和連出活動的記錄中介軟體。

## <a name="the-bot-middleware-pipeline"></a>Bot 中介軟體管道

針對每個活動，介面卡可依**您新增中介軟體的順序**進行呼叫。 針對該回合和 _next_ 委派，介面卡會在內容物件中傳遞，然後中介軟體會呼叫委派，並將控制項傳遞至管道中的下個中介軟體。 中介軟體也有機會在 _next_ 委派傳回之後，先執行其他工作，再完成方法。 您可以想成每個中介軟體物件都有第一次和最後一次的機會，能在管道中和接續於中介軟體物件之後的項目進行互動。

例如︰

- 第 1 個中介軟體物件的回合處理常式在呼叫 _next_ 之前先執行程式碼。
  - 第 2 個中介軟體物件的回合處理常式在呼叫 _next_ 之前先執行程式碼。
    - Bot 的回合處理常式執行並傳回。
  - 第 2 個中介軟體物件的回合處理常式在傳回之前，執行任何其餘程式碼。
- 第 1 個中介軟體物件的回合處理常式在傳回之前，執行任何其餘程式碼。

如果中介軟體未呼叫下個委派，則介面卡不會呼叫任何後續中介軟體或 Bot 回合處理常式，以及管道最少運算路由。

Bot 中介軟體管道完成後，該回合即結束，且回合內容將超出範圍。

中介軟體或 Bot 可產生回應和註冊回應事件處理常式，不過請注意，這些回應會在個別程式中處理。

## <a name="order-of-middleware"></a>中介軟體的順序

由於中介軟體新增的順序會影響其處理活動的順序，因此請務必先決定好新增順序。

> [!NOTE]
> 這表示您會獲得適用於大部分的 Bot 的模式；但請務必考量在您的情境中，中介軟體和使用情境下與其他使用者的互動方式。

中介軟體管道中的第一個項目可能是每次都會執行的最低層級工作。 例如：記錄、例外狀況處理、狀態管理和翻譯。 排列順序取決於您的需求，例如，您想要先翻譯內送訊息，再處理任何例外狀況；或者先處理例外狀況，然後再翻譯例外狀況訊息。

中介軟體管道的最後一個項目是 Bot 特定中介軟體，即您實作的中介軟體，用來處理每次傳送給 Bot 的訊息。 如果您的中介軟體使用狀態資訊或其他 Bot 內容中設定的資訊，請將其新增至中介軟體管道中，用於修改狀態或內容的中介軟體之後。

## <a name="short-circuiting"></a>最少運算路由

另一個有關中介軟體 (和[事件處理常式](~/v4sdk/bot-builder-concept-activity-processing.md#response-event-handlers)) 的重要概念是_最少運算路由_。 如果系統繼續透過後續的執行層處理該執行作業，則中介軟體 (或處理常式) 必須呼叫其 _next_ 委派傳遞執行。  如果未在該中介軟體 (或處理常式) 中呼叫下個委派，目前的管道會產生最少運算路由，而後續執行層也不會執行。 這表示所有 Bot 邏輯，以及管道中後續的任何中介軟體都會略過。

針對事件處理常式，不呼叫 _next_ 代表事件已取消，這與中介軟體略過邏輯大為不同。 藉由不處理其餘事件，介面卡就永遠無法傳送。

> [!TIP]
> 如果您執行最少運算路由事件 (例如 `SendActivities`)，請確保其為您預期的行為。 否則可能會導致令人困擾的錯誤。

## <a name="next-steps"></a>後續步驟

現在您已熟悉 Bot 的一些重要概念，接下來讓我們深入了解 Bot 如何傳送主動式訊息。

> [!div class="nextstepaction"]
> [主動式傳訊](~/v4sdk/bot-builder-proactive-messages.md)
